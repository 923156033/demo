+function(c){var d=function(f,e){this.$element=c(f);this.options=c.extend({},d.DEFAULTS,e);this.init()};d.NAME="ExtDropdownTree";d.VERSION="1.0.0";d.DEFAULTS={width:"100%",containerCss:{minWidth:"200px"},templateResult:function(f,e){return null},language:"zh-CN",tags:false,dropdownCssClass:"ext-dropdown-tree",clickMode:"toggle",onlyChildSelect:true,fetchAll:false};d.prototype.init=function(){var n=this.$element;var o=this.options;var j=this;n.addClass("select2-ignore");var e=c('<ul class="ztree" style="min-height: 30px"></ul>');j.$ztree=e;var i="ztree-"+App.getUniqueID("dropdown-tree-");e.attr("id",i);e.attr("id-for",i);j.$ztree.hide();n.after(j.$ztree);n.select2(o);j.options.multiple=n.data("select2").options.options.multiple;var l=function(t,p){var s=false;for(var q in p){if(p[q].id==t.id){s=true;break}}if(!s){p.push(t);if(t._level==undefined){t._level=0}t.isParent=true;if(t.hasChildren!=undefined&&t.hasChildren==false){t.isParent=false}var r=t.parent;if(r&&r.depth>0){t.parent=r.id;r._level=t._level+1;l(r,p)}}};var k=function(q){var p=[];c.each(q.content,function(r,s){l(s,p)});p.sort(function(s,r){return r.lft-s.lft});return p};var m=function(){j.zTree.cancelSelectedNode();n.children("option:selected").each(function(){j.zTree.selectNode(j.zTree.getNodeByParam("id",c(this).val()),true,true)})};var h=function(){var q=n.data("select2");var p=q.$selection.find(".select2-search__field");if(p.size()==0){p=q.$dropdown.find(".select2-search__field")}p.off("keydown");p.off("input");p.off("keyup");p.on("keyup",function(s){if(s.keyCode==13){var w=j.zTree.getSelectedNodes();if(w&&w.length==1){var u=w[0];var r=n.children("option[value='"+u.id+"']:selected");if(r.length<1){var v=u.tId;c("#"+v+"_a").click();p.val("")}return}}var t=c(this).val();j.lastTerm=t;if(j.delayTimer){window.clearTimeout(j.delayTimer)}j.delayTimer=window.setTimeout(function(){j.delayTimer=null;j.$ztree.css({minHeight:j.$ztree.height()});f(t)},50)});j.$ztree.off("dblclick");j.$ztree.on("dblclick","span[treenode_switch]",function(r){var t=c(r.target);var v=t.attr("id");var u=v.replace("_switch","");var s=j.zTree.getNodeByTId(u);j.zTree.reAsyncChildNodes(s,"refresh")})};var g=function(v,t){if(v.content==undefined||v.content.length==0){return}var r=j.zTree;if(r&&!o.fetchAll){r.destroy();r=undefined}if(r==undefined){r=c.fn.zTree.init(e,{async:{enable:true,url:Util.smartParseURL(o.url),type:"get",autoParam:["id="+o.parentName],dataFilter:function(y,w,x){return k(x)}},view:{showIcon:false,autoCancelSelected:true,selectedMulti:j.options.multiple},data:{key:{name:"display"},simpleData:{enable:true,idKey:"id",pIdKey:"parent",rootPId:0}},callback:{beforeClick:function(z,y,x){if(o.onlyChildSelect&&y.isParent){return false}var A=n.find("option[value='"+y.id+"']");if(A.length==0){if(!j.options.multiple){n.children("option:selected").remove()}var w=new Option(y.display,y.id,true,true);n.append(w)}else{A.remove();if(n.children("option").size()<=0){n.append(new Option("","",true,true))}}n.trigger("change.select2");if(!j.options.multiple){n.select2("close")}return false},onAsyncSuccess:function(){m()}}},k(v));if(o.fetchAll){r.expandAll(true)}j.zTree=r}if(t!=undefined&&c.trim(t)!=""){var q=r.getNodesByParamFuzzy("display",c.trim(t));for(var s=0,p=q.length;s<p;s++){var u=q[s];r.selectNode(u,true,true)}}else{m()}};var f=function(r){var q=j.$ztree;var p=o.url;p=Util.addOrReplaceUrlParameter(p,"rows","1000");p=Util.addOrReplaceUrlParameter(p,"_view","tree");if(o.fetchAll){}else{if((r==undefined||r=="")&&n.val()){p=Util.addOrReplaceUrlParameter(p,"search[IN_id]",n.val())}else{if(c.trim(r)!=""){p=Util.addOrReplaceUrlParameter(p,o.queryName,c.trim(r))}else{p=Util.addOrReplaceUrlParameter(p,"search[NU_parent]","true")}}}if(j.cachedAllData){g(j.cachedAllData,r)}else{q.parent().ajaxJsonUrl(p,function(s){if(o.fetchAll){j.cachedAllData=s}g(s,r)},{sidx:"lft",sord:"desc"})}};n.on("select2:open",function(p){var q=n.data("select2");q.$dropdown.children(".select2-dropdown").append(j.$ztree);j.$ztree.show();h();if(j.ztreeInitialize==undefined){j.ztreeInitialize=true;f()}else{q.$dropdown.find(".select2-search__field").val(j.lastTerm)}});n.on("select2:closing",function(p){j.$ztree.hide();n.after(j.$ztree);if(n.attr("required")=="required"||n.attr("required")=="true"||n.attr("data-rule-required")=="true"){var q=n.closest("form");if(q.size()&&q.data("validation")){n.valid()}}});n.on("change.select2",function(p){setTimeout(function(){h();m()},50)})};function b(f){var e=arguments;return this.each(function(){var i=c(this);var h=i.data("ExtDropdownTree");var g=c.extend({},i.data(),typeof f=="object"&&f);if(!h){i.data("ExtDropdownTree",(h=new d(this,g)))}if(typeof f=="string"){h[f].apply(h,c.makeArray(e).slice(1))}})}var a=c.fn.extDropdownTree;c.fn.extDropdownTree=b;c.fn.extDropdownTree.Constructor=d;c.fn.extDropdownTree.noConflict=function(){c.fn.extDropdownTree=a;return this};Global.addComponent({name:"ExtDropdownTree",plugin:b,runPoint:Global.Component_Run_Point.BeforeAjaxPageShow,expr:'select[data-toggle="dropdown-tree"]',order:900})}(jQuery);